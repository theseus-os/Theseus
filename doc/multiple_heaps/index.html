<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="An implementation of an allocator that uses multiple heaps. The heap that will be used on each allocation is determined by a key. Right now we use the apic id as the key, so that we have per-core heaps."><title>multiple_heaps - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-f40c346f39d9abc1.css" id="mainThemeStyle"><div id="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="multiple_heaps" data-themes="" data-resource-suffix="" data-rustdoc-version="1.72.0-nightly (065a1f5df 2023-06-21)" data-search-js="search-95c92dd01058facf.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-0f8c037637f9eb3e.css" data-theme-dark-css="dark-1097f8e92a01e3cf.css" data-theme-ayu-css="ayu-614652228113ac93.css" ></div><script src="../static.files/storage-62ce34ea385b278a.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-190c35055d2a8300.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../static.files/light-0f8c037637f9eb3e.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../static.files/dark-1097f8e92a01e3cf.css"><link rel="stylesheet" href="../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../multiple_heaps/index.html"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../multiple_heaps/index.html"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Crate multiple_heaps</a></h2><div class="sidebar-elems"><ul class="block"><li class="version">Version 0.1.0</li><li><a id="all-types" href="all.html">All Items</a></li></ul><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#constants">Constants</a></li><li><a href="#functions">Functions</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Crate <a class="mod" href="#">multiple_heaps</a><button id="copy-path" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../src/multiple_heaps/lib.rs.html#1-643">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>An implementation of an allocator that uses multiple heaps. The heap that will be used on each allocation is determined by a key.
Right now we use the apic id as the key, so that we have per-core heaps.</p>
<p>The heaps are ZoneAllocators (given in the slabmalloc crate). Each ZoneAllocator maintains 11 separate “slab allocators” for sizes
8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096 and (8KiB - bytes of metadata) bytes. The maximum allocation size is given by <code>ZoneAllocator::MAX_ALLOC_SIZE</code>.
The slab allocator maintains linked lists of allocable pages from which it allocates objects of the same size. 
The allocable pages are 8 KiB (<code>ObjectPage8k::SIZE</code>), and have metadata stored in the ending bytes (<code>ObjectPage8k::METADATA_SIZE</code>).
The metadata includes a heap id, MappedPages object this allocable page belongs to, forward and back pointers to pages stored in a linked list and a
bitmap to keep track of allocations. The maximum allocation size can change if the size of the objects in the metadata change. If that happens it will be automatically
reflected in the constants <code>ZoneAllocator::MAX_ALLOC_SIZE</code> and <code>ObjectPage8k::METADATA_SIZE</code></p>
<p>Any memory request greater than maximum allocation size, a large allocation, is satisfied through a request for pages from the kernel.
All other requests are satisfied through the per-core heaps.</p>
<p>The per-core heap which will be used on allocation is determined by the cpu that the task is running on.
On deallocation of a block, the heap id is retrieved from metadata at the end of the allocable page which contains the block.</p>
<p>When a per-core heap runs out of memory, pages are first moved between the slab allocators of the per-core heap, then requested from other per-core heaps.
If no empty pages are available within any of the per-core heaps, then more virtual pages are allocated from the range of virtual addresses dedicated to the heap
<a href="../kernel_config/memory/constant.KERNEL_HEAP_START.html">KERNEL_HEAP_START</a> and dynamically mapped to physical memory frames.</p>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.MultipleHeaps.html" title="struct multiple_heaps::MultipleHeaps">MultipleHeaps</a></div><div class="desc docblock-short">An allocator that contains multiple heaps. The heap that is used on each allocation is
determined by a key. Currently the apic id is used as the key.</div></li></ul><h2 id="constants" class="small-section-header"><a href="#constants">Constants</a></h2><ul class="item-table"><li><div class="item-name"><a class="constant" href="constant.PER_CORE_HEAP_INITIAL_SIZE_PAGES.html" title="constant multiple_heaps::PER_CORE_HEAP_INITIAL_SIZE_PAGES">PER_CORE_HEAP_INITIAL_SIZE_PAGES</a></div><div class="desc docblock-short">Starting size of each per-core heap. </div></li></ul><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.init_individual_heap.html" title="fn multiple_heaps::init_individual_heap">init_individual_heap</a></div><div class="desc docblock-short">Initializes the heap given by <code>key</code>.
There are 11 size classes in each heap ranging from [8,16,32,64 ..<code>ZoneAllocator::MAX_ALLOC_SIZE</code>].
We evenly distribute the pages allocated for each heap between the size classes. </div></li><li><div class="item-name"><a class="fn" href="fn.switch_to_multiple_heaps.html" title="fn multiple_heaps::switch_to_multiple_heaps">switch_to_multiple_heaps</a></div><div class="desc docblock-short">The setup routine for multiple heaps. It creates and initializes the multiple heaps,
then sets the multiple heaps as the default allocator.
Only call this function when the multiple heaps are ready to be used.</div></li></ul></section></div></main></body></html>