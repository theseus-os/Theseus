<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Swaps in new crates that can optionally replace existing crates in this `CrateNamespace`."><meta name="keywords" content="rust, rustlang, rust-lang, swap_crates"><title>swap_crates in crate_swap - Rust</title><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../ayu.css" disabled ><script id="default-settings"></script><script src="../storage.js"></script><script src="../crates.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="icon" type="image/svg+xml" href="../favicon.svg">
<link rel="alternate icon" type="image/png" href="../favicon-16x16.png">
<link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><style type="text/css">#crate-search{background-image:url("../down-arrow.svg");}</style></head><body class="rustdoc fn"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu" role="button">&#9776;</div><a href='../crate_swap/index.html'><div class='logo-container rust-logo'><img src='../rust-logo.png' alt='logo'></div></a><div class="sidebar-elems"><p class="location"><a href="index.html">crate_swap</a></p><div id="sidebar-vars" data-name="swap_crates" data-ty="fn" data-relpath=""></div><script defer src="sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu"><img src="../brush.svg" width="18" height="18" alt="Pick another theme!"></button><div id="theme-choices" role="menu"></div></div><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><button type="button" id="help-button">?</button>
                <a id="settings-menu" href="../settings.html"><img src="../wheel.svg" width="18" height="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class="fqn"><span class="in-band">Function <a href="index.html">crate_swap</a>::<wbr><a class="fn" href="">swap_crates</a><button id="copy-path" onclick="copy_path(this)"><img src="../clipboard.svg" width="19" height="18" alt="Copy item import"></button></span><span class="out-of-band"><span id="render-detail"><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span><a class="srclink" href="../src/crate_swap/lib.rs.html#126-778" title="goto source code">[src]</a></span></h1><pre class="rust fn">pub fn swap_crates(<br>&nbsp;&nbsp;&nbsp;&nbsp;this_namespace: &amp;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/sync/struct.Arc.html" title="struct alloc::sync::Arc">Arc</a>&lt;<a class="struct" href="../mod_mgmt/struct.CrateNamespace.html" title="struct mod_mgmt::CrateNamespace">CrateNamespace</a>&gt;, <br>&nbsp;&nbsp;&nbsp;&nbsp;swap_requests: <a class="type" href="type.SwapRequestList.html" title="type crate_swap::SwapRequestList">SwapRequestList</a>, <br>&nbsp;&nbsp;&nbsp;&nbsp;override_namespace_dir: <a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="struct" href="../mod_mgmt/struct.NamespaceDir.html" title="struct mod_mgmt::NamespaceDir">NamespaceDir</a>&gt;, <br>&nbsp;&nbsp;&nbsp;&nbsp;state_transfer_functions: <a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/string/struct.String.html" title="struct alloc::string::String">String</a>&gt;, <br>&nbsp;&nbsp;&nbsp;&nbsp;kernel_mmi_ref: &amp;<a class="type" href="../memory/type.MmiRef.html" title="type memory::MmiRef">MmiRef</a>, <br>&nbsp;&nbsp;&nbsp;&nbsp;verbose_log: bool, <br>&nbsp;&nbsp;&nbsp;&nbsp;cache_old_crates: bool<br>) -&gt; <a class="enum" href="https://doc.rust-lang.org/nightly/core/result/enum.Result.html" title="enum core::result::Result">Result</a>&lt;(), &amp;'static str&gt;</pre><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Swaps in new crates that can optionally replace existing crates in this <code>CrateNamespace</code>.</p>
<p>See the documentation of the <a href="#struct.SwapRequest.html"><code>SwapRequest</code></a> struct for more details.</p>
<p>In general, the strategy for replacing an old crate <code>C</code> with a new crate <code>C2</code> consists of three steps:</p>
<ol>
<li>Load the new replacement crate <code>C2</code> from its object file.</li>
<li>Copy the .data and .bss sections from old crate <code>C</code> to the new crate <code>C2</code></li>
<li>Set up new relocation entries that redirect all dependencies on the old crate <code>C</code> to the new crate <code>C2</code>.</li>
<li>Remove crate <code>C</code> and clean it up, e.g., removing its entries from the symbol map.
Save the removed crate (and its symbol subtrie) in a cache for later use to expedite future swapping operations.</li>
</ol>
<p>The given <code>CrateNamespace</code> is used as the backup namespace for resolving unknown symbols,
in adddition to any recursive namespaces on which this namespace depends.</p>
<p>Upon a successful return, this namespace (and/or its recursive namespace) will have the new crates in place of the old ones,
and the old crates will be completely removed from this namespace. 
In this namespace there will be no remaining dependencies on the old crates, 
although crates in other namespaces may still include and depend upon those old crates.</p>
<h1 id="arguments" class="section-header"><a href="#arguments">Arguments</a></h1>
<ul>
<li><code>swap_requests</code>: a list of several <code>SwapRequest</code>s, in order to allow swapping multiple crates all at once 
as a single “atomic” procedure, which prevents weird linking/relocation errors, 
such as a new crate linking against an old crate that already exists in this namespace
instead of linking against the new one that we want to replace that old crate with. </li>
<li><code>override_namespace_dir</code>: the directories of object files from which missing crates should be loaded.
If a crate cannot be found in this directory set, this namespace’s directory set will be searched for the crate. 
If <code>None</code>, only this <code>CrateNamespace</code>’s directory set (and its recursive namespace’s) will be used to find missing crates to be loaded.</li>
<li><code>state_transfer_functions</code>: the fully-qualified symbol names of the state transfer functions, 
arbitrary functions that are invoked after all of the new crates are loaded but before the old crates are unloaded, 
in order to allow transfer of states from old crates to new crates or proper setup of states for the new crates.
These function should exist in the new namespace (or its directory set) and should take the form of a 
<a href="../type.StateTransferFunction.html"><code>StateTransferFunction</code></a>.
The given functions are invoked with the arguments <code>(current_namespace, new_namespace)</code>, 
in which the <code>current_namespace</code> is the one currently running that contains the old crates,
and the <code>new_namespace</code> contains only newly-loaded crates that are not yet being used.
Both namespaces may (and likely will) contain more crates than just the old and new crates specified in the swap request list.</li>
<li><code>kernel_mmi_ref</code>: a reference to the kernel’s <code>MemoryManagementInfo</code>.</li>
<li><code>verbose_log</code>: enable verbose logging.</li>
</ul>
<h1 id="warning-correctness-not-guaranteed" class="section-header"><a href="#warning-correctness-not-guaranteed">Warning: Correctness not guaranteed</a></h1>
<p>This function currently makes no attempt to guarantee correct operation after a crate is swapped. 
For example, if the new crate changes a function or data structure, there is no guarantee that 
other crates will be swapped alongside that one. 
It will most likely error out, but this responsibility is currently left to the caller.</p>
<h1 id="crate-swapping-optimizations" class="section-header"><a href="#crate-swapping-optimizations">Crate swapping optimizations</a></h1>
<p>When one or more crates is swapped out, they are not fully unloaded, but rather saved in a cache
in order to accelerate future swapping commands. </p>
</div></details></section><section id="search" class="content hidden"></section><div id="rustdoc-vars" data-root-path="../" data-current-crate="crate_swap" data-search-index-js="../search-index.js" data-search-js="../search.js"></div>
    <script src="../main.js"></script></body></html>